name: C++ Kriging Benchmarks

on:
  push:
    branches:
      - master
      - '*'
    tags:
      - 'bench-cpp*'
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of iterations per test'
        required: false
        default: '10'

env:
  DEBUG_CI: false

jobs:
  benchmark-cpp:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            liblapack-dev \
            libblas-dev \
            gfortran

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v1.13
        with:
          cmake-version: '3.24.x'

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_OCTAVE_BINDING=OFF \
            -DENABLE_PYTHON_BINDING=OFF \
            -DENABLE_R_BINDING=OFF

      - name: Run all benchmark configurations
        shell: bash
        run: |
          ITERATIONS=${{ github.event.inputs.iterations || '10' }}

          # Initialize results directory
          mkdir -p build/benchmark-results

          # Run all combinations using bench.sh (it handles building internally)
          # Use --clean for the first benchmark to ensure fresh compilation
          FIRST_RUN=true
          for n in 100 200 400; do
            for d in 2 4 8; do
              for bench in kriging nuggetkriging noisekriging; do
                echo "Running: n=$n d=$d benchmark=$bench iterations=$ITERATIONS"
                if [ "$FIRST_RUN" = true ]; then
                  bash bench/bench.sh --clean iterations=$ITERATIONS n=$n d=$d $bench > "build/benchmark-results/${bench}_n${n}_d${d}.log" 2>&1 || echo "Warning: benchmark failed for $bench n=$n d=$d"
                  FIRST_RUN=false
                else
                  bash bench/bench.sh iterations=$ITERATIONS n=$n d=$d $bench > "build/benchmark-results/${bench}_n${n}_d${d}.log" 2>&1 || echo "Warning: benchmark failed for $bench n=$n d=$d"
                fi
              done
            done
          done

      - name: Generate markdown report
        shell: bash
        run: |
          cd build
          ITERATIONS=${{ github.event.inputs.iterations || '10' }}
          REPORT="benchmark-results/BENCHMARK_REPORT.md"

          # Header
          echo "# C++ Kriging Benchmarks Report" > "$REPORT"
          echo "" >> "$REPORT"
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$REPORT"
          echo "**Platform:** Ubuntu (latest)" >> "$REPORT"
          echo "**Build Type:** Release" >> "$REPORT"
          echo "**Iterations per test:** $ITERATIONS" >> "$REPORT"
          echo "**Test function:** f(x) = sum_i sin(2*pi*x_i)" >> "$REPORT"
          echo "" >> "$REPORT"

          # Table of Contents
          echo "## Table of Contents" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "- [Summary Tables](#summary-tables)" >> "$REPORT"
          echo "  - [Kriging](#kriging)" >> "$REPORT"
          echo "  - [NuggetKriging](#nuggetkriging)" >> "$REPORT"
          echo "  - [NoiseKriging](#noisekriging)" >> "$REPORT"
          echo "- [Detailed Results](#detailed-results)" >> "$REPORT"
          echo "" >> "$REPORT"

          # Summary Tables
          echo "## Summary Tables" >> "$REPORT"
          echo "" >> "$REPORT"

          # Kriging Summary
          echo "### Kriging" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "| n   | d | fit (ms) | predict (ms) | update (ms) |" >> "$REPORT"
          echo "|-----|---|----------|--------------|-------------|" >> "$REPORT"
          for n in 100 200 400; do
            for d in 2 4 8; do
              logfile="benchmark-results/kriging_n${n}_d${d}.log"
              if [ -f "$logfile" ]; then
                fit=$(grep "^fit" "$logfile" | awk '{print $3}' || echo "N/A")
                pred=$(grep "^predict" "$logfile" | awk '{print $3}' || echo "N/A")
                upd=$(grep "^update " "$logfile" | awk '{print $3}' || echo "N/A")
                echo "| $n | $d | $fit | $pred | $upd |" >> "$REPORT"
              fi
            done
          done
          echo "" >> "$REPORT"

          # NuggetKriging Summary
          echo "### NuggetKriging" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "| n   | d | fit (ms) | predict (ms) | update (ms) |" >> "$REPORT"
          echo "|-----|---|----------|--------------|-------------|" >> "$REPORT"
          for n in 100 200 400; do
            for d in 2 4 8; do
              logfile="benchmark-results/nuggetkriging_n${n}_d${d}.log"
              if [ -f "$logfile" ]; then
                fit=$(grep "^fit" "$logfile" | awk '{print $3}' || echo "N/A")
                pred=$(grep "^predict" "$logfile" | awk '{print $3}' || echo "N/A")
                upd=$(grep "^update " "$logfile" | awk '{print $3}' || echo "N/A")
                echo "| $n | $d | $fit | $pred | $upd |" >> "$REPORT"
              fi
            done
          done
          echo "" >> "$REPORT"

          # NoiseKriging Summary
          echo "### NoiseKriging" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "| n   | d | fit (ms) | predict (ms) | update (ms) |" >> "$REPORT"
          echo "|-----|---|----------|--------------|-------------|" >> "$REPORT"
          for n in 100 200 400; do
            for d in 2 4 8; do
              logfile="benchmark-results/noisekriging_n${n}_d${d}.log"
              if [ -f "$logfile" ]; then
                fit=$(grep "^fit" "$logfile" | awk '{print $3}' || echo "N/A")
                pred=$(grep "^predict" "$logfile" | awk '{print $3}' || echo "N/A")
                upd=$(grep "^update " "$logfile" | awk '{print $3}' || echo "N/A")
                echo "| $n | $d | $fit | $pred | $upd |" >> "$REPORT"
              fi
            done
          done
          echo "" >> "$REPORT"

          # Detailed Results
          echo "## Detailed Results" >> "$REPORT"
          echo "" >> "$REPORT"

          for bench in kriging nuggetkriging noisekriging; do
            BENCH_NAME="${bench^}"
            if [ "$bench" = "nuggetkriging" ]; then BENCH_NAME="NuggetKriging"; fi
            if [ "$bench" = "noisekriging" ]; then BENCH_NAME="NoiseKriging"; fi

            echo "### $BENCH_NAME" >> "$REPORT"
            echo "" >> "$REPORT"

            for n in 100 200 400; do
              for d in 2 4 8; do
                logfile="benchmark-results/${bench}_n${n}_d${d}.log"
                if [ -f "$logfile" ]; then
                  echo "#### Configuration: n=$n, d=$d" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "\`\`\`" >> "$REPORT"
                  cat "$logfile" | grep -A 100 "n=$n d=$d" | grep -v "Results saved" >> "$REPORT"
                  echo "\`\`\`" >> "$REPORT"
                  echo "" >> "$REPORT"
                fi
              done
            done
          done

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: cpp-benchmark-results
          path: |
            build/benchmark-results/*.log
            build/benchmark-results/BENCHMARK_REPORT.md
          retention-days: 90

      - name: Display summary report
        shell: bash
        run: |
          cd build
          cat benchmark-results/BENCHMARK_REPORT.md

      - name: Add report to job summary
        shell: bash
        run: |
          cd build
          cat benchmark-results/BENCHMARK_REPORT.md >> $GITHUB_STEP_SUMMARY
